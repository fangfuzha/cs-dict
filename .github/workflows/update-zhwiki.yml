name: Update Zhwiki Dictionary

on:
  # æ¯å‘¨æ—¥å‡Œæ™¨3ç‚¹è‡ªåŠ¨æ£€æŸ¥æ›´æ–°
  schedule:
    - cron: "0 3 * * 0"

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_update:
        description: "å¼ºåˆ¶æ›´æ–°ï¼ˆå³ä½¿ç‰ˆæœ¬ç›¸åŒï¼‰"
        required: false
        default: "false"
        type: boolean

  # ç›‘å¬ä¸Šæ¸¸ä»“åº“çš„å‘å¸ƒäº‹ä»¶ï¼ˆéœ€è¦webhooké…ç½®ï¼‰
  repository_dispatch:
    types: [zhwiki-release]

jobs:
  update-dictionary:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: è®¾ç½®PythonçŽ¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: å®‰è£…ä¾èµ–åŒ…
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: é…ç½®Gitç”¨æˆ·ä¿¡æ¯
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: è¿è¡Œæ›´æ–°è„šæœ¬
        id: update
        run: |
          cd ${{ github.workspace }}

          # è¿è¡Œæ›´æ–°è„šæœ¬
          if [ "${{ github.event.inputs.force_update }}" = "true" ]; then
            python script/update_zhwiki.py --force
          else
            python script/update_zhwiki.py
          fi

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
          if git diff --quiet dict/zhwiki-*.dict; then
            echo "updated=false" >> $GITHUB_OUTPUT
            echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          else
            echo "updated=true" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°æ–‡ä»¶å·²æ›´æ–°"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: æäº¤å¹¶æŽ¨é€æ›´æ”¹
        if: steps.update.outputs.updated == 'true'
        run: |
          git add .

          # ä»Žstatus.jsonèŽ·å–ç‰ˆæœ¬å’Œè¯åº“ä¿¡æ¯
          if [ -f "logs/zhwiki_status.json" ]; then
            VERSION=$(python -c "import json; data=json.load(open('logs/zhwiki_status.json')); print(data.get('version', 'unknown'))")
            DICT_NAME=$(python -c "import json; data=json.load(open('logs/zhwiki_status.json')); print(data.get('latest_dict_name', 'unknown'))")
            DICT_DATE=$(python -c "import json; data=json.load(open('logs/zhwiki_status.json')); print(data.get('latest_dict_date', 'unknown'))")
            
            git commit -m "è‡ªåŠ¨æ›´æ–° zhwiki è¯åº“åˆ°ç‰ˆæœ¬ $VERSION
            
            - ç‰ˆæœ¬: $VERSION
            - è¯åº“æ–‡ä»¶: $DICT_NAME
            - è¯åº“æ—¥æœŸ: $DICT_DATE
            - è‡ªåŠ¨ä»Ž https://github.com/felixonmars/fcitx5-pinyin-zhwiki æ›´æ–°
            - æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          else
            git commit -m "è‡ªåŠ¨æ›´æ–° zhwiki è¯åº“
            
            - è‡ªåŠ¨ä»Ž https://github.com/felixonmars/fcitx5-pinyin-zhwiki æ›´æ–°
            - æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          fi

          git push

      - name: è¾“å‡ºæ›´æ–°ç»†èŠ‚åˆ°GitHub Actionsæ‘˜è¦
        if: steps.update.outputs.updated == 'true'
        run: |
          if [ -f "logs/zhwiki_status.json" ]; then
            VERSION=$(python -c "import json; data=json.load(open('logs/zhwiki_status.json')); print(data.get('version', 'unknown'))")
            DICT_NAME=$(python -c "import json; data=json.load(open('logs/zhwiki_status.json')); print(data.get('latest_dict_name', 'unknown'))")
            DICT_DATE=$(python -c "import json; data=json.load(open('logs/zhwiki_status.json')); print(data.get('latest_dict_date', 'unknown'))")
            
            echo "## ðŸ“ æ›´æ–°æ—¥å¿—" >> update_summary.md
            echo "" >> update_summary.md
            echo "zhwiki è¯åº“å·²æ›´æ–°åˆ°ç‰ˆæœ¬ **$VERSION**" >> update_summary.md
            echo "" >> update_summary.md
            echo "### ðŸ“Š æ–‡ä»¶ä¿¡æ¯" >> update_summary.md
            
            if [ -f "dict/$DICT_NAME" ]; then
              SIZE=$(stat -c%s "dict/$DICT_NAME")
              LINES=$(wc -l < "dict/$DICT_NAME")
              echo "- æ–‡ä»¶å: $DICT_NAME" >> update_summary.md
              echo "- æ–‡ä»¶å¤§å°: $(numfmt --to=iec-i --suffix=B $SIZE)" >> update_summary.md
              echo "- æ€»è¡Œæ•°: $LINES" >> update_summary.md
              
              # å°è¯•æå–è¯æ¡æ•°é‡ï¼ˆä»Ždictæ–‡ä»¶å¤´éƒ¨ï¼‰
              TOTAL_ENTRIES=$(grep ";;TOTAL=" "dict/$DICT_NAME" | head -1 | cut -d'=' -f2 2>/dev/null || echo "æœªçŸ¥")
              echo "- è¯æ¡æ•°é‡: $TOTAL_ENTRIES" >> update_summary.md
            fi
            
            echo "" >> update_summary.md
            echo "### ðŸ”— æºæ–‡ä»¶" >> update_summary.md
            echo "- æ¥æº: [fcitx5-pinyin-zhwiki](https://github.com/felixonmars/fcitx5-pinyin-zhwiki)" >> update_summary.md
            echo "- ç‰ˆæœ¬: $VERSION" >> update_summary.md
            echo "- è¯åº“æ–‡ä»¶: $DICT_NAME" >> update_summary.md
            echo "- è¯åº“æ—¥æœŸ: $DICT_DATE" >> update_summary.md
            echo "- æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> update_summary.md
            
            # è¾“å‡ºåˆ°GitHub Actionsæ‘˜è¦
            cat update_summary.md >> $GITHUB_STEP_SUMMARY
          fi

      - name: ä¸Šä¼ æ›´æ–°æ—¥å¿—ä½œä¸ºæž„å»ºäº§ç‰©
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zhwiki-update-logs
          path: |
            logs/zhwiki_update.log
            logs/zhwiki_status.json
          retention-days: 30

      - name: å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "## âŒ æ›´æ–°å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "zhwiki è¯åº“æ›´æ–°è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æ£€æŸ¥æ—¥å¿—æ–‡ä»¶èŽ·å–è¯¦ç»†ä¿¡æ¯ã€‚" >> $GITHUB_STEP_SUMMARY

          if [ -f "logs/zhwiki_update.log" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“ é”™è¯¯æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -n 50 logs/zhwiki_update.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
